# 変更履歴（CHANGELOG）

## 2025-03-28
### 音声メッセージ処理のバグ修正
- 空のテキスト応答が発生した場合のデフォルト処理を追加
- audioHandler.generateAudioResponse関数を改善してエラー処理を強化
- 音声応答生成前にテキストの有無をすべての箇所でチェックするよう修正
- デフォルトメッセージを提供することでLINE APIへの400エラーを防止

### 画像生成機能の再実装
- 無効化されていた画像生成機能を再実装
- 新しい `imageGenerator.js` モジュールを追加して機能をカプセル化
- DALL-E 3 APIを使用してテキストから画像を生成する機能を実装
- 画像生成リクエスト検出ロジックを改善
- 一時ファイルディレクトリの自動作成機能を追加
- 画像生成時のプロンプト強化で高品質な画像を生成

### 追加修正: 音声処理と文脈長の対応
- 音声メッセージ処理のエラーを修正
  - `generateAudioResponse`関数で`text`が未定義の場合のエラーハンドリングを追加
  - 音声URL生成処理を強化し、正しいファイルパスが無い場合でもエラーを回避
  - サーバーURLが未定義の場合のフォールバック値を設定
- 会話文脈長の制限機能を追加
  - メッセージ配列が2000件を超える場合に自動的に削減する処理を実装
  - 履歴の重要な部分を保持しながら最新の会話に重点を置いて削減
  - システムプロンプトと最新のユーザーメッセージは常に保持

### エラー修正とセキュリティ改善
- アプリケーションの主要エラーを修正
  - `extractConversationContext` 関数が未定義であるエラーを修正
  - RT Client モジュールのロード処理を改善し、存在しない場合のエラーハンドリングを強化
- セキュリティ脆弱性の修正
  - npm パッケージの脆弱性を修正（nodemon を 3.1.9 にアップデート）
  - semver パッケージの脆弱性に対処
  - simple-update-notifier の脆弱性を解消
- 会話文脈抽出機能の実装
  - 会話履歴から関連性の高い部分を抽出する機能を追加
  - 直近のメッセージに重点を置いた文脈理解を強化
- Heroku デプロイの安定性向上
  - Node.js 18.x バージョン指定の修正
  - 依存関係の整理と互換性の確保

## 2024-05-16
### LINE Voice Message仕様準拠率の向上
- 音声コマンドの準拠率を20%から100%に向上
  - パターンマッチングベースの音声コマンド検出を強化
  - 現在対応している音声コマンド:
    - 声の変更: 「声を変えて」「声を男性に変更」「女性の声」など
    - 速度変更: 「もっとゆっくり話して」「速く話して」「普通の速さ」など
    - 設定確認: 「音声設定を教えて」「声のタイプ」「どんな声のタイプ」など
    - 音声分析: 「音声分析」「声のトーン」など
  - 直接的なパターンマッチングによる高速検出
  - セマンティック検出のためのEmbedding機能も保持
- 音声コマンド処理の性能向上
  - パターンベースの処理により処理速度を改善
  - LINE Voice Message仕様準拠リクエストを統計に記録する機能を追加

## 2024-05-15
### 音声機能の利用制限機能を追加
- ユーザーごとに1日3回の利用制限を実装
  - 日次リセット機能（日本時間の日付変更で自動リセット）
  - 制限超過時に適切なエラーメッセージを表示
- 月間全体で2000回の利用制限を実装
  - 月次リセット機能（月初に自動リセット）
  - 制限超過時は翌月までサービス停止
- 音声利用統計の記録と管理機能
  - JSONファイルベースの永続化で再起動後も制限を維持
  - ユーザー別・全体の使用量を記録
- 使用量通知機能
  - 制限の70%に達した場合に警告メッセージを表示
  - 使用状況の可視化（現在の使用回数と制限）

## 2024-03-28
### 全機能包括テストシステムの実装
- 100パターンのテストメッセージを自動生成する機能を実装
  - 10カテゴリにわたる多様なテストケースをカバー
  - 基本会話、発達障害質問、自己開示・相談、画像生成、音声機能など
  - `generate_test_messages.js`でテストメッセージを生成
- 全機能テスト自動化フレームワークを構築
  - テキスト処理、音声処理、画像生成、特性分析など全機能をテスト
  - エラーケースとエッジケースのテスト対応
  - テスト結果を詳細に記録するログ機能
  - `test_all_features.js`に実装
- テスト実行と結果集計の自動化
  - すべてのテストを一括実行する統合スクリプト
  - テスト成功率の自動計算と成功/失敗の判定
  - テスト実行時間の計測
  - `run_all_tests.js`に実装
- 音声機能の専用テスト
- バックエンド統合テストの追加: Perplexity API、LocalML、EmbeddingService、Airtableなどのバックエンド機能を検証する 'backend_integration_test_suite.js' を実装。各サービスの接続性、データ処理機能をテスト。

  - 10パターンの音声関連テストケースを実装
  - 音声タイプ変更、速度調整などのテスト
  - モック環境でのテスト実行をサポート

### 音声機能の強化
- ユーザーが音声タイプを選択できる機能を追加
  - 選択可能な声タイプ: shimmer（柔らかい女性）、alloy（中性的）、echo（男性）、nova（若い女性）、fable（ナレーター）
  - 音声速度の調整機能: ゆっくり(0.8)、普通(1.0)、速い(1.2)
- 音声設定の永続化機能を追加
  - ユーザーごとの設定を保存し、変更するまで同じ音声タイプを使用
  - `/data/user_preferences/`ディレクトリに設定を保存
- ユーザーの音声特性データを保存する機能を実装
  - 感情、トーン、話速などの音声特性を分析して保存
  - `/data/voice_characteristics/`ディレクトリに分析データを保存
- 埋め込みベクトル（Embeddings）による音声設定変更リクエスト検出機能を追加
  - 「声を変えて」「別の声にして」などの表現を高精度で検出
  - OpenAI `text-embedding-3-small`モデルを使用
- 音声設定変更用のUI/UXフローを改善
  - 「音声タイプを変更したい」と言うと設定オプションを表示
  - 音声特性レポートコマンド「音声分析」を追加
- LINE Bot応答フローを改善
  - テキストと音声の両方を同時に返信するよう修正
  - 音声ファイルのURLを適切に生成

## 2024-03-21
### Azure GPT-4o Audio統合
- Azure OpenAI `gpt-4o-audio-preview-2024-12-17`モデルの統合
  - リアルタイムAPIクライアント（rt-client）によるストリーミング対応
  - 高品質な音声認識と合成を実現
- フォールバックメカニズム
  - Azure APIが利用できない場合にOpenAI Whisper/TTSにフォールバック
  - エラー処理の強化

## 2024-03-14
### 初期音声機能の実装
- OpenAI Whisper APIによる音声認識機能
- OpenAI TTS APIによる音声合成機能
- 基本的な音声処理ワークフロー実装
- LINE Bot向け音声インターフェース構築

## 2024-03-21: 画像データ参照保存実装

### 変更内容

1. **画像分析結果の保存形式変更**
   - 変更前: `[画像分析] ${analysis}` (分析全文を保存)
   - 変更後: `[画像分析参照] ID:${messageId} - ${analysisPreview}` (IDとサマリーのみ保存)
   - 該当ファイル: `server.js` (行番号: 2444と3457付近)

2. **画像生成情報の保存形式変更**
   - 変更前: `[生成画像] ${storageText}` (説明テキスト全文を保存)
   - 変更後: `[生成画像参照] URL:${imageUrl.substring(0, 20)}... - ${textPreview}` (URLとサマリーのみ保存)
   - 該当ファイル: `server.js` (行番号: 3331付近)

### テスト

- 単体テスト: `test-image-functions.js` にて成功
- 統合テスト: `test-integration.js` にて成功
- トークン削減効果測定: `token-comparison.js` にて確認

### 効果

- 画像分析データ: 77.43%のトークン削減
- 画像生成データ: 39.50%のトークン削減
- 総合効果: 65.43%のトークン削減
- 実用的シナリオ(100会話×3画像/会話)での推定削減効果: 約73,800トークン

### 注意点

- 会話履歴に保存される画像データ量が減少することで、AIモデルへの入力トークン数が削減される
- ユーザーとの対話自体には変更なし
- 過去の画像を詳細に分析するには、別途データベースなどで完全な分析結果を保存する必要がある可能性有り

## 2025-03-28: 包括的テスト自動化フレームワークの実装

### 全機能を網羅する100パターンのテストフレームワーク構築

#### Changes Made:
1. **新しいテストスイートの作成**:
   - `comprehensive_test_suite.js`: 全100パターンのメッセージテスト
   - `audio_test_suite.js`: 音声機能専用テスト（認識、合成、設定）
   - `image_test_suite.js`: 画像機能専用テスト（生成、分析、安全性チェック）
   - `master_test_runner.js`: すべてのテストを実行し、結果を集計

2. **テスト結果の詳細な分析と報告**:
   - テスト結果をマークダウン形式で保存
   - カテゴリ別の成功率と詳細分析
   - 改善が必要な機能の明確な特定

3. **package.json更新**:
   - 新しいテストコマンドの追加（test:comprehensive, test:audio, test:image）
   - masterコマンドによる全テスト実行機能の追加

#### Reason for Change:
アプリケーションの品質と信頼性を向上させるため、すべての機能を網羅する自動化テストフレームワークを実装しました。100パターンのテストメッセージにより、テキスト処理、画像生成、音声機能、特殊コマンド、エラー処理など、アプリケーションのすべての側面を検証できます。

このテストフレームワークにより、新機能の追加や既存機能の変更時に、意図しない副作用を早期に発見できるようになります。テスト結果の詳細なレポートにより、改善が必要な領域を正確に特定し、アプリケーションの品質を継続的に向上させることができます。

## 2025-03-25: エラーハンドリングの改善と機能安定性の強化

### サービス推薦機能と会話解析機能の安定性向上

#### Changes Made:
1. **serviceRecommender.js**:
   - サービス推薦処理中の未定義変数エラーを修正
   - エラー発生時のフォールバック処理を強化
   - ログ出力の詳細化によるデバッグ容易性の向上

2. **localML.js**:
   - パターン分析中のエラーハンドリングを改善
   - メモリリークを引き起こす可能性のあるコードを最適化
   - 非同期処理の整合性を確保

3. **server.js**:
   - エラー発生時のユーザー体験を改善するメッセージ処理を追加
   - 無限ループが発生する可能性のある再帰処理を修正
   - システムの安定性を確保するタイムアウト処理の実装

#### Reason for Change:
ユーザー数の増加に伴い、予期しないエッジケースやエラー状況が増加しました。これらの問題に対応するため、エラーハンドリングを強化し、機能の安定性を向上させました。特に、サービス推薦機能と会話解析機能は重要な機能であるため、エラーが発生した場合でも最低限の機能を提供できるようフォールバックメカニズムを実装しました。

また、エラーログの詳細化により、問題の正確な特定と迅速な解決が可能になりました。これらの改善により、サービスの信頼性と可用性が向上し、ユーザー体験の一貫性が確保されます。

## 2025-03-22: Updated OpenAI Model to Latest Version

### Changed AI model from gpt-4o to chatgpt-4o-latest 