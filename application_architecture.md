# LINE OpenAI Voice Chat アプリケーションの詳細アーキテクチャ

このドキュメントは、LINE OpenAI Voice Chatアプリケーションの詳細なアーキテクチャと主要機能について説明します。アプリケーションは、LINE MessagingプラットフォームとOpenAI、Anthropic、Perplexityなどの複数のAI APIを統合し、ユーザーとの会話を処理します。

## 1. アプリケーションの概要

LINE OpenAI Voice Chatは、Node.jsベースのチャットボットアプリケーションで、LINEメッセージングプラットフォームを通じてユーザーと対話します。このアプリケーションは、テキストメッセージの理解と応答、画像の処理と生成、サービス推奨、ユーザーの混乱検出などの機能を提供します。

### 主要な統合技術
- **LINE Messaging API**: ユーザーとの対話インターフェース
- **OpenAI API**: テキスト処理、画像生成(DALL-E)
- **Anthropic API**: バックアップAIモデル
- **Perplexity API**: キャリアモード用のAPI（オプション）
- **TensorFlow.js**: ローカルの機械学習処理
- **Airtable**: サービス推奨データの保存

## 2. アプリケーションの構造

アプリケーションは、複数のモジュールで構成されており、各モジュールが特定の機能を担当しています。主なモジュールと役割は以下の通りです：

### 2.1 コアモジュール

#### `server.js`
アプリケーションのメインファイルで、以下の機能を提供します：
- LINEプラットフォームとの統合
- メッセージの受信と処理
- ユーザーの状態管理
- AIモデルの連携
- ルーティング

#### `userNeedsAnalyzer.js`
ユーザーのニーズ分析を担当し、メッセージからユーザーの意図と要望を抽出します。

#### `serviceRecommender.js`
ユーザーの会話コンテキストに基づいて、適切なサービスを推奨します。

#### `mlHook.js` / `mlIntegration.js`
機械学習ベースの処理を担当し、テキスト分析や意図検出などを提供します。

#### `db.js`
データベース操作を抽象化し、ユーザー情報や会話履歴の保存・取得を担当します。

### 2.2 機能モジュール

#### `advice_patterns.js`
アドバイス要求パターンの定義を含み、ユーザーがアドバイスを求めているかを検出するために使用されます。

#### `services.js`
推奨可能なサービスの定義とメタデータを含みます。

#### `perplexitySearch.js`
Perplexity APIを利用した検索機能を提供します。

## 3. 主要な機能フロー

### 3.1 メッセージ処理フロー

1. **WebhookイベントのLINEプラットフォームからの受信**
   - `handleEvent()` がイベントタイプを判断し、適切なハンドラを呼び出します

2. **テキストメッセージの処理（`handleText()`）**
   - ユーザーメッセージの保存
   - 特別なコマンドの処理（ヘルプなど）
   - 混乱表現の検出と画像説明の提案
   - メッセージモードとコンテキスト制限の決定
   - AIによる応答生成
   - サービス推奨の追加（条件に合う場合）
   - ユーザーへの返信

3. **画像メッセージの処理（`handleImage()`）**
   - 画像の取得と分析
   - 分析結果のユーザーへの返信

### 3.2 お勧め機能（サービス推奨機能）

サービス推奨はハイブリッドアプローチ（「トリガーワード + LLMの文脈分析」）で動作します：

1. **トリガーワードの検出**
   - `detectAdviceRequest()` 関数で、`advice_patterns.js` に定義された明示的なアドバイス要求パターンを検出

2. **LLMによる文脈分析**
   - `analyzeShouldShowRecommendation()` 関数でLLM（gpt-4o-mini）を使用して文脈を理解
   - ユーザーの発言が「サービスやおすすめを求めている」のか「拒否・否定している」のかを判断

3. **エラー処理とフォールバック**
   - LLM呼び出しに問題がある場合は、トリガーワードベースの判断にフォールバック

4. **サービスのフィルタリングと表示**
   - ユーザーの会話履歴とコンテキストに基づいて適切なサービスを選択
   - 選択されたサービスをAIの応答に追加

### 3.3 混乱検出と画像生成機能

1. **混乱表現の検出**
   - `isConfusionRequest()` - パターンベースの検出
   - `isConfusionRequestWithLLM()` - LLM（gpt-4o-mini）を使用した高度な検出

2. **画像説明の提案**
   - 混乱が検出された場合、ユーザーに画像による説明を提案
   - ユーザーの同意を待つ

3. **DALL-Eによる画像生成（`handleVisionExplanation()`）**
   - 説明テキストの前処理と整形
   - OpenAI API（DALL-E 3）を使用した画像生成
   - 生成された画像のLINEへの送信
   - 会話履歴への保存

### 3.4 エラー処理とフォールバック戦略

アプリケーションには堅牢なエラー処理と複数のフォールバック戦略が実装されています：

1. **AIモデルのフォールバック**
   - プライマリモデル（OpenAI）に問題が発生した場合、バックアップモデル（Anthropic）に切り替え

2. **タイムアウト処理とリトライ**
   - 長時間実行される操作（履歴検索など）のタイムアウト処理
   - 失敗した操作の自動リトライメカニズム

3. **安全な初期値**
   - 必要なデータが取得できない場合の安全なデフォルト値

## 4. セキュリティ機能

アプリケーションには多層的なセキュリティ機能が実装されています：

1. **入力検証と無害化**
   - `sanitizeUserInput()` 関数でユーザー入力をXSSや他の攻撃から保護
   - `validateUserId()` でユーザーIDの検証

2. **レート制限**
   - APIエンドポイントの乱用防止のためのレート制限

3. **環境変数の検証**
   - 起動時に必須環境変数の検証

4. **データ処理のセキュリティ**
   - データベース接続と認証情報の安全な処理

## 5. 拡張機能

### 5.1 機械学習統合

TensorFlow.jsを使用したローカルの機械学習処理機能：

- テキスト分析
- 意図検出
- 感情分析

### 5.2 データ永続化

- Airtableを使用したサービス推奨データの保存
- ローカルストレージへのフォールバック

## 6. 設定と環境変数

アプリケーションは`.env`ファイルで設定され、以下の主要な環境変数を使用します：

- LINE Messaging API認証情報
- OpenAI API キー
- Anthropic API キー（オプション）
- Perplexity API キー（オプション）
- データベース接続情報
- Airtable認証情報（オプション）

## 7. デプロイメントとスケーリング

アプリケーションはNode.jsランタイムで動作し、以下の方法でデプロイできます：

- Herokuへのデプロイ
- Docker コンテナ
- その他のNode.jsをサポートするPaaSプラットフォーム

## 8. 監視とログ記録

アプリケーションには詳細なログ記録が実装されており、以下の情報を追跡します：

- APIリクエストとレスポンス
- エラーとシステム状態
- ユーザーの行動とフィードバック
- パフォーマンスメトリクス

## 9. 今後の拡張可能性

アプリケーションは以下の方向への拡張を考慮した設計になっています：

- 新しいAIモデルの統合
- マルチモーダル機能の強化
- パーソナライゼーションの向上
- 多言語サポートの拡張

## 10. テスト

アプリケーションのテストには以下のアプローチが含まれます：

- 単体テスト
- 統合テスト
- エンドツーエンドテスト
- パフォーマンステスト

---

このドキュメントは、LINE OpenAI Voice Chatアプリケーションのコンポーネント、機能、およびアーキテクチャを包括的に説明しており、開発者が迅速にシステムを理解し、拡張または修正できるようにすることを目的としています。 