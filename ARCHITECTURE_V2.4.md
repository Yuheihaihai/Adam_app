# Adam AI アシスタント - アーキテクチャ概要 v2.4

## システム概要
Adam AI アシスタントは、LINE Bot を通じて発達障害支援のためのAIカウンセリングを提供するシステムです。主要なコンポーネントは、自然言語処理、画像解析・生成、音声処理、ユーザー特性分析、リソース推奨機能などで構成されています。

**注意**: 2025年6月28日現在、GNN（Graph Neural Network）機能は一時的に削除されており、システムはv754の状態で稼働中です。

## コアコンポーネント

### 1. メッセージ処理パイプライン
- **エントリポイント**: `server.js` の `handleEvent` 関数
- **種類別処理**:
  - テキストメッセージ: `handleText` 関数で処理
  - 画像メッセージ: `handleImage` 関数で処理
  - 音声メッセージ: `handleAudio` 関数で処理 (v2.4で追加)
- **管理コマンド処理**: `checkAdminCommand`関数で制御コマンドを検出・処理
- **セキュリティ**: XSSフィルタリング、入力サニタイズ、レート制限

### 2. 自然言語処理
- **主要API**: OpenAI GPT-4o
- **バックアップAPI**: Anthropic Claude & Claude Instant
- **フォールバックメカニズム**: エラー発生時に自動的にバックアップAPIへ切り替え
- **会話モード**:
  - 通常モード: 一般的な質問応答
  - 深掘りモード: 複雑な質問に詳細な回答
  - ASD特化モード: 自閉症スペクトラム障害に特化した応答

### 3. 画像処理
- **画像解析**: OpenAI Vision API (GPT-4o)
- **画像生成**: DALL-E 3
- **画像安全性**: コンテンツモデレーション

### 4. 音声処理 (v2.4で追加)
- **音声認識**: OpenAI Whisper API
- **テキスト音声変換**: OpenAI TTS API
- **音声フォーマット処理**: LINE Bot互換形式変換
- **設定管理**: ユーザーごとの音声設定
- **利用制限と通知**:
  - 利用制限: 1日3回/ユーザー、月間上限
  - 制限管理: `insightsService.trackAudioRequest`で追跡
  - 制限解除通知: 過去の利用者への一括通知機能

### 5. ユーザー特性分析
- **基本分析**: OpenAI GPT-4oによる分析
- **二層構造分析** (v2.4で追加): 
  - 第1層: Google Gemini API による詳細な構造化分析
  - 第2層: OpenAI GPT-4o による共感的応答生成
- **キャッシュ機構**: 分析結果の3日間キャッシュ
- **GNN機能**: 削除済み（2025年6月28日）
  - ~~外部GNN API連携~~
  - ~~10次元特徴量ベクトルから64次元埋め込みベクトルへの変換~~
  - ~~LLMを使用した2層検証システム~~
  - ~~構造化ユーザー特性分析（年齢、性別、教育レベル、職業、発達特性等）~~

### 6. データ永続化
- **会話履歴**: PostgreSQL (主) と Airtable (バックアップ)
- **洞察データ** (v2.4で追加): ファイルベースの構造化保存
- **利用統計**: `insightsService`による利用状況の追跡と保存

### 7. サービス推奨エンジン
- **マッチングアルゴリズム**: ベクトル埋め込みによる類似度計算
- **フィルタリング**: 信頼度スコアと親和性に基づくフィルタリング
- **ユーザー設定**: サービス表示のカスタマイズオプション

### 8. プッシュ通知システム (v2.4で追加)
- **機能通知**: 音声利用制限解除などの機能更新をユーザーに通知
- **対象者抽出**: 過去の利用履歴に基づく通知対象者の特定
- **レート制限**: LINE API制限に配慮した段階的通知配信
- **履歴管理**: 通知履歴の保存による重複防止

## 削除されたコンポーネント（2025年6月28日）
### GNN（Graph Neural Network）機能
- **削除されたファイル**:
  - `gnnClient.js`: GNN API連携クライアント
  - `gnnFeatures.js`: GNN特徴量生成モジュール
- **削除された機能**:
  - 外部GNN API連携（https://issp-gnn-api-394682330281.asia-northeast1.run.app/predict）
  - 高次元特徴量ベクトル変換
  - 構造化ユーザー特性分析
- **理由**: システムの簡素化と保守性向上のため一時的に削除

## アーキテクチャ図 (論理構成)
```
+-------------------+    +-------------------+    +-------------------+
|    LINE Bot API   | <- |    Web Server     | <- |  Express Router   |
+-------------------+    +-------------------+    +-------------------+
                                  |
                                  v
+-------------------+    +-------------------+    +-------------------+
|  メッセージ処理    | -> | プロンプト生成     | -> |    LLM APIs       |
|   パイプライン     |    |   エンジン        |    | (OpenAI/Anthropic) |
+-------------------+    +-------------------+    +-------------------+
         |                       ^                        |
         v                       |                        v
+-------------------+    +-------------------+    +-------------------+
|   メディア処理     |    |   特性分析        |    |   レスポンス      |
| (画像/音声/テキスト)|    |   エンジン        |    |   生成エンジン    |
+-------------------+    +-------------------+    +-------------------+
         |                       ^                        |
         v                       |                        v
+-------------------+    +-------------------+    +-------------------+
|    データ永続化    | -> |  洞察サービス     | -> |   サービス推奨    |
|     レイヤー       |    |                  |    |     エンジン      |
+-------------------+    +-------------------+    +-------------------+
                                  |
                                  v
                         +-------------------+
                         |   通知システム     |
                         | (プッシュ通知管理) |
                         +-------------------+
```

## 主要ファイル構成
- `server.js`: アプリケーションのエントリポイント、主要ロジック
- `audioHandler.js`: 音声処理モジュール (v2.4で追加)
- `enhancedCharacteristicsAnalyzer.js`: 二層構造特性分析 (v2.4で追加)
- `insightsService.js`: 洞察データ収集・分析、音声利用制限管理 (v2.4で追加)
- `serviceRecommender.js`: サービス推奨機能
- `userNeedsAnalyzer.js`: ユーザーニーズ分析
- `embeddingService.js`: ベクトル埋め込み処理

## システム要件
- Node.js 18+
- PostgreSQL 14+
- OpenAI API キー
- LINE Messaging API キー
- (オプション) Google Gemini API キー
- (オプション) Anthropic API キー
- (オプション) Airtable API キー

## 拡張性とフォールバック機構
システムは複数のLLMプロバイダを利用し、主要APIが利用できない場合は自動的にバックアップAPIに切り替えます。各モジュールは疎結合設計であり、新機能の追加や変更が容易に行えます。キャッシュ機構を導入することで、繰り返し行われる処理のパフォーマンスを最適化しています。 